# Story 1.3: Authentication & Business Context

## Status

Draft

## Story

**As a** business owner,
**I want** secure authentication with automatic business context,
**so that** I can safely access my business data without seeing other businesses' information.

## Acceptance Criteria

1. Supabase Auth integration supports email/password login and registration
2. JWT tokens include business_id for automatic tenant context
3. Row Level Security policies filter all database queries by current business_id
4. Login form validates credentials and provides clear error messages
5. Authentication state persists across browser sessions
6. Logout functionality clears all authentication tokens and business context
7. Protected routes redirect unauthenticated users to login page
8. Business context automatically set in API calls via middleware

## Tasks / Subtasks

- [ ] Task 1: Implement Supabase Auth Integration (AC: 1, 5)
  - [ ] 1.1 Write tests for authentication service with email/password scenarios
  - [ ] 1.2 Create authentication service wrapper for Supabase Auth
  - [ ] 1.3 Implement user registration with email/password validation
  - [ ] 1.4 Add login functionality with credential validation and error handling
  - [ ] 1.5 Implement session persistence across browser sessions
  - [ ] 1.6 Verify authentication flows work correctly with proper error handling

- [ ] Task 2: Create JWT Token Management with Business Context (AC: 2, 8)
  - [ ] 2.1 Write tests for JWT token management and business context integration
  - [ ] 2.2 Extend JWT tokens to include business_id for multi-tenant context
  - [ ] 2.3 Create middleware to automatically set business context in API calls
  - [ ] 2.4 Implement token refresh functionality with business context preservation
  - [ ] 2.5 Add API interceptor to include business_id in all authenticated requests
  - [ ] 2.6 Verify business context is properly maintained across all API operations

- [ ] Task 3: Implement Row Level Security Context Management (AC: 3)
  - [ ] 3.1 Write tests for RLS context setting and business isolation verification
  - [ ] 3.2 Create RLS context helper functions for setting current_business_id
  - [ ] 3.3 Implement automatic business context setting after authentication
  - [ ] 3.4 Add business context validation before database operations
  - [ ] 3.5 Create business context switching utilities for session management
  - [ ] 3.6 Verify complete business data isolation through RLS policies

- [ ] Task 4: Create Login Form and Authentication Pages (AC: 4, 7)
  - [ ] 4.1 Write tests for login form validation and authentication flow
  - [ ] 4.2 Create login page with email/password form using Zod validation
  - [ ] 4.3 Implement credential validation with clear Spanish error messages
  - [ ] 4.4 Add loading states and error handling for authentication process
  - [ ] 4.5 Create protected route wrapper component for route protection
  - [ ] 4.6 Implement automatic redirect to login for unauthenticated users
  - [ ] 4.7 Verify login flow redirects to dashboard after successful authentication

- [ ] Task 5: Implement Logout and Session Management (AC: 6)
  - [ ] 5.1 Write tests for logout functionality and session cleanup
  - [ ] 5.2 Create logout function that clears Supabase session and tokens
  - [ ] 5.3 Implement business context cleanup on logout
  - [ ] 5.4 Add localStorage cleanup for business_id and session data
  - [ ] 5.5 Create session timeout handling with automatic logout
  - [ ] 5.6 Verify complete authentication cleanup and redirect to login

## Dev Notes

### Technical Architecture Context

This story implements secure authentication with multi-tenant business context management using Supabase Auth as the core authentication provider. The authentication system must establish proper tenant isolation through JWT tokens containing business_id and Row Level Security policies that automatically filter database queries by current business context.

[Source: PRD - Epic 1: Foundation & Business Registration, Story 1.3]

### Authentication Provider Requirements

**Supabase Auth Integration:** The system uses Supabase Auth 2.0+ as the authentication provider with email/password authentication as the primary method. Authentication must integrate with the existing Supabase client configuration and support JWT token-based session management with automatic refresh capabilities.

**Email/Password Authentication:** Primary authentication method supporting business owner registration and login with proper email validation and password strength requirements. Must provide clear Spanish error messages for Colombian business users and handle authentication errors gracefully.

[Source: architecture/02-tech-stack.md#authentication]

### JWT Token and Multi-Tenant Context

**JWT Token Structure:** Supabase Auth JWT tokens must be extended to include business_id for automatic tenant context. The business_id should be included in the token payload after successful business registration and maintained throughout the user session for multi-tenant isolation.

**Business Context Management:** After authentication, the system must automatically set the business context using the current_setting('app.current_business_id') PostgreSQL function for Row Level Security. Business context must persist across browser sessions and be automatically applied to all database queries.

**API Request Context:** All authenticated API requests must include the business_id in headers for multi-tenant isolation. API middleware must validate business context and ensure users can only access their own business data.

[Source: architecture/04-database-schema.md#multi-tenant-security-design]

### Row Level Security Integration

**RLS Policy Enforcement:** All database tables with business_id columns have Row Level Security policies that filter queries by current_setting('app.current_business_id')::UUID. The authentication system must set this context automatically after login using PostgreSQL session variables.

**Business Context Setting:** After successful authentication, the system must execute SET app.current_business_id = '<business_id>' to establish tenant context for the database session. This ensures all subsequent queries are automatically filtered by the user's business.

**Context Validation:** Before any database operation, the system should verify that business context is properly set and matches the authenticated user's business_id. Invalid or missing business context should result in authentication errors and logout.

[Source: architecture/04-database-schema.md#businesses, architecture/04-database-schema.md#multi-tenant-security-design]

### Authentication State Management

**State Management Strategy:** Use Zustand for authentication state management with persistence across browser sessions. Authentication store should maintain user object, business context, loading states, and error handling for all authentication operations.

**Session Persistence:** Authentication state must persist across browser sessions using localStorage for business_id and Supabase's built-in session management for JWT tokens. Session restoration should automatically set business context and verify token validity.

**Real-time Updates:** Authentication state should integrate with Supabase real-time subscriptions for session changes, token refresh, and business context updates. Authentication state must be synchronized across multiple browser tabs.

[Source: architecture/06-frontend-architecture.md#state-management-architecture]

### Authentication Flow Implementation

**Login Page Structure:** Create login page at /login using Next.js App Router with email/password form. Form should use Zod validation schemas with Spanish error messages and Colombian business-friendly terminology. Login success should redirect to business dashboard with proper business context.

**Protected Route Pattern:** Implement ProtectedRoute wrapper component that checks authentication status and business context before rendering protected pages. Unauthenticated users should be redirected to /login with return URL handling.

**Registration Integration:** Authentication system must integrate with existing business registration flow from Story 1.2. After business registration, users should be automatically authenticated and redirected to dashboard with business context established.

[Source: architecture/06-frontend-architecture.md#routing-architecture]

### API Middleware and Business Context

**Request Interceptors:** Implement axios request interceptors that automatically add Authorization header with Bearer token and X-Business-ID header with current business context. All authenticated API requests must include both authentication and business context.

**Response Interceptors:** Handle authentication errors (401) by automatically logging out users and redirecting to login page. Handle business context errors by clearing invalid business context and prompting for re-authentication.

**Business Context Validation:** API middleware must validate that business_id in JWT token matches X-Business-ID header to prevent business context spoofing. Invalid business context should result in 403 Forbidden responses.

[Source: architecture/06-frontend-architecture.md#api-service-layer]

### Logout and Session Cleanup

**Complete Session Cleanup:** Logout must clear Supabase session, JWT tokens, business context from localStorage, and reset authentication state in Zustand store. Any real-time subscriptions should be unsubscribed and database session context cleared.

**Automatic Session Timeout:** Implement session timeout handling that automatically logs out users after JWT token expiry (1 hour). Users should be notified of impending session timeout and given option to extend session.

**Cross-Tab Synchronization:** Logout in one browser tab should automatically log out all other tabs using localStorage events and Supabase session management. Authentication state should be synchronized across all application instances.

[Source: architecture/02-tech-stack.md#authentication-authorization]

### Spanish Error Messages and Colombian UX

**Error Message Localization:** All authentication error messages must be displayed in Spanish with Colombian business terminology. Common errors include invalid credentials, network issues, session timeout, and business context problems.

**Colombian Business Context:** Authentication forms should use Colombian business-friendly language and terminology. Form labels, placeholders, and help text should be appropriate for Colombian service business owners.

**Accessibility Requirements:** Authentication forms must meet WCAG AA accessibility standards with proper ARIA labels, keyboard navigation, and screen reader support for Colombian users with disabilities.

[Source: PRD - UI Design Goals, architecture/06-frontend-architecture.md#colombian-market-specializations]

### Previous Story Integration

**Business Registration Integration:** This authentication system must work seamlessly with the business registration components created in Story 1.2. The ColombianBusinessForm should automatically authenticate users after successful registration and establish business context.

**Database Utilities Integration:** Leverage the database utilities and RLS policies implemented in Story 1.2 for business context management. The authentication system should use existing business validation functions and database connectivity.

**Component Reuse:** Reuse validation schemas, error handling patterns, and Spanish localization from Story 1.2. Authentication forms should maintain consistency with business registration form styling and validation approaches.

[Source: Story 1.2 Dev Agent Record - Task 4 and Task 5 completion notes]

### Testing

#### Testing Requirements from Architecture

**Frontend Testing:** Jest + React Testing Library for authentication component testing  
**Backend Testing:** Jest + Supertest for authentication API endpoint testing  
**Location:** Tests should be co-located with implementation files using .test.ts/.test.tsx extensions

**Required Test Coverage:**
- Authentication service with email/password login and registration scenarios
- JWT token management and business context integration 
- Row Level Security context setting and business isolation verification
- Login form validation and authentication flow testing
- Protected route functionality and redirect behavior
- Logout functionality and complete session cleanup
- API middleware business context validation and error handling

**Testing Frameworks:**
- Jest 29+ for all testing
- React Testing Library 14+ for component tests  
- Supertest 6+ for API endpoint tests
- Use TypeScript for all test files

[Source: architecture/02-tech-stack.md#development--testing]

## Story Documentation

- Tasks: @docs/stories/1.3.authentication-business-context/tasks.md

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-14 | 1.0 | Initial story creation with comprehensive authentication architecture context from Supabase Auth integration requirements | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled during implementation*

### Debug Log References

*To be filled during implementation*

### Completion Notes List

*To be filled during implementation*

### File List

*To be filled during implementation*

## QA Results

*Results from QA Agent review of the completed story implementation will be added here*